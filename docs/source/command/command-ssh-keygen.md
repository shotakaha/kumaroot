# SSH鍵したい（`ssh-keygen`）

```console
// SSH鍵ペアの確認
$ ssh-keygen -l
Enter file in which the key is (~/.ssh/id_ed25519):

// SSH鍵ペアの生成
$ ssh-keygen -t ed25519

// SSH鍵ペアの登録
$ ssh-add
Enter passphrase for ~/.ssh/id_ed25519
```

`ssh-keygen`コマンドでSSH鍵（公開鍵と秘密鍵のペア）を生成できます。
この鍵はSSH認証の自動化などに利用できます。

各種サービスの認証に登録するのは必ず**公開鍵**です。
秘密鍵は絶対に誰にも渡してはいけないデータです。
もし、秘密鍵が漏洩してしまった場合は、
外部に登録した公開鍵を削除したり、
その端末のSSH鍵を再作成したりする必要があります。

SSH鍵は頻繁に作成するものでもないため、
これまでにSSH鍵を作成したことがあるかどうか、
どの暗号アルゴリズムで鍵を生成したのか、
など忘れてしまっていることも多いと思います。
`-l`オプションで既存のSSH鍵のフィンガープリントなどを表示できるので、
作成したような記憶がある場合は、まず確認してみるとよいです。

:::{note}

SSH鍵はデフォルトで`~/.ssh/`に作成されます。
ディレクトリを直接確認してもよいですが、
`ssh-keygen -l`するほうがお手軽です。

:::

## SSH鍵ペアを作りたい（`ssh-keygen`）

```console
$ ssh-keygen -t ed25519 -C "コメント"
$ ssh-keygen -t ed25519 -C "ユーザー名_パソコンの名前_作成年"
$ ssh-keygen -t ed25519 -f {service}_ed25519 -C "$(whoami)_$(hostname)_$(date +'%Y')"
```

`ssh-keygen`コマンドでSSH鍵（公開鍵と秘密鍵のペア）を作成できます。
秘密鍵には専用のマスターパスワードを設定してください。

:::{note}

このマスターパスワードは、生成した秘密鍵を使用するのに必要な唯一のパスワードです。

リモートサーバーにログインするパスワードや、その他のサービスのパスワードとは関係がないので、まったく別の文字列にして構いません。

:::

`-t`オプションで暗号化アルゴリズムを変更できます。
選択した暗号化アルゴリズム名を元に
`~/.ssh/`に**秘密鍵**と**公開鍵**のファイルが生成されます。
`-f`オプションで保存先を変更できます。

:::{note}

ファイル名の末尾に`.pub`がついているのが**公開鍵**、
ついていないのが**秘密鍵**です。
EdCSA鍵を指定した場合は、デフォルトで
`~/.ssh/id_ed25519.pub`（公開鍵）と
`~/.ssh/id_ed25519`（秘密鍵）となります。

:::

`-C`オプションでコメントを指定できます。
このコメントは人間が識別するための役割で、公開鍵暗号の認証（や検証）には関係ありません。
「誰が（`$(whoami)`）」
「どの端末で（`$(hostname)`）」
「いつ（`$(date +"%Y")`）」
作ったかがわかるようにしておくとよいと思います。

:::{note}

コメントは公開鍵に保存されます。
公開鍵は誰でも閲覧可能なデータとなるため、秘匿すべき情報は入力しないようにしてください。

以前は「メールアドレス」を書くのが慣習であると説明していましたが、
個人情報の露出を控えたい場合は、自分が識別できる内容に限定して問題ありません。

:::

:::{hint}

職場と自宅で別々の端末を利用するなど、ひとりで複数の端末を所有している場合は多いと思います。
その場合、端末同士は**別人**と考えて、端末ごとにSSH鍵ペアを生成するのがよいです。
各種サービスにもそれぞれの公開鍵を登録します。

ある端末で作成したSSH鍵ペア（の秘密鍵）を、別の端末にコピーして使い回すのでは、
公開鍵暗号を利用する意味がありません。

:::

## 暗号化アルゴリズムを変更したい（`ssh-keygen -t`）

```console
// RSA鍵
$ ssh-keygen
id_rsa
id_rsa.pub

// DSA鍵（1024ビット推奨）
$ ssh-keygen -t dsa
id_dsa
id_dsa.pub

// ECDSA鍵（256ビット推奨）
$ ssh-keygen -t ecdsa
id_ecdsa
id_ecdsa.pub

// EdCSA鍵（256ビット推奨）
$ ssh-keygen -t ed25519
id_ed25519
id_ed25519.pub
```

`-t`オプションで暗号化アルゴリズムを変更できます。
暗号化アルゴリズムは`rsa` / `dsa` / `ecdsa` / `ed25519` の4種類から選択できます。
デフォルトは`rsa`となっています。

現時点（2025年）では、`ed25519`が推奨されています。
サービスが`EdDSCA`に対応しているならば、迷わず選択しましょう。

## 鍵の長さを変更したい（`ssh-keygen -b`）

```console
// RSA鍵（2048ビット以上推奨）
$ ssh-keygen -b 4096

// DSA鍵（1024ビット推奨）
$ ssh-keygen -t dsa -b 1024

// ECDSA鍵（256ビット推奨）
$ ssh-keygen -t ecdsa -b 256

// EdCSA鍵（256ビット推奨）
$ ssh-keygen -t ed25519 -b 256
```

`-b`オプションで暗号鍵の長さ（＝ビット数）を変更できます。
それぞれの暗号化アルゴリズムの長さの推奨値を載せておきます。
RSA鍵を使う場合は`-b 4096`に変更するとよいみたいです。
その他の鍵はデフォルトでよいです。

## 鍵の名前を変更したい（`ssh-keygen -f`）

```console
// GitHub用
$ ssh-keygen -t ed25519 -f ~/.ssh/github_ed25519
// GitLab用
$ ssh-keygen -t ed25519 -f ~/.ssh/gitlab_ed25519
```

`-f`オプションで、SSH鍵ぺアのファイル名を変更できます。
このようにして、サービスごとに鍵を生成できます。

:::{hint}

ある秘密鍵が漏洩してしまった場合、その鍵ペアを無効（削除）にする必要があります。
つまり、関連するすべてのサービスの再設定が必要になります。

サービスごとに鍵を生成していた場合は、当該鍵ペアを無効にして、再設定すればOKです。
ただし、サービス数が増えると管理が煩雑になります。
サービスごとに鍵を生成するかどうかは、ユーザー自身の利用形態に合わせて検討してみてください。

:::

## 秘密鍵をキーチェーンに登録したい（`ssh-add`）

```console
// 秘密鍵を登録する
$ ssh-add
Enter passphrase for ~/.ssh/id_ed25519: # 秘密鍵のパスワードを入力
Identity added: ~/.ssh/id_ed25519

// 登録を確認する
$ ssh-add -l
256 SHA256:鍵情報 (ED25519)

// macOSの場合: KeyChainに登録する
$ ssh-add --apple-use-keychain ~/.ssh/id_ed25519（秘密鍵）
Identity added: 鍵のパス
```

`ssh-add`コマンドを使って、端末の`ssh-agent`に秘密鍵を登録できます。
`ssh-add -l`で登録してある鍵の情報を確認できます。

`ssh-agent`は、秘密鍵の情報を専用メモリに記憶して管理するSSH鍵の番人です。
ログアウトや再起動するとリセットされるため、SSH接続する前に、毎回`ssh-add`する必要があります。

:::{note}

[SSHの設定ファイル](./command-ssh.md)で
`AddKeysToAgent yes`を設定すると、
SSH接続時に自動で`ssh-add`できます。
初回接続時だけ秘密鍵のパスワード入力が必要ですが、以降のセッションでの接続時にはパスワード入力を省略できます。

:::

macOSの場合は
`--apple-use-keychain`することで、
KeyChainアプリに秘密鍵のパスワードを保存できます。
SSH接続時には、KeyChainアプリから秘密鍵のパスワードを取得して`ssh-agent`と連携してくれるため、ユーザーによるパスワード入力を省略できます。

:::{note}

GitHubなどを公開鍵認証にしていると、プッシュするたびにSSH鍵のマスターパスワードの入力が必要です。
SSHエージェントに登録しておくと、その入力が省略できます。

:::

## 公開鍵をリモートサーバ登録したい（``ssh-copy-id``）

```console
// 公開鍵をリモートサーバに登録する
$ ssh-copy-id -i ~/.ssh/id_ed25519.pub アカウント名@リモートサーバ
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "~/.ssh/id_ed25519.pub"
...（省略）...
アカウント名@リモートサーバ's password:    ## リモートサーバのログインパスワードを入力

Number of key(s) added:        1
...（省略）...
```

``ssh-copy-id``コマンドを使って、SSH公開鍵をリモートサーバに登録できます。
ひとつのリモートサーバに対して複数の公開鍵を登録できます。
職場と自宅で別々の端末を使っている場合は、端末ごとの公開鍵を登録できます。

```console
// すでに登録されている公開鍵を、追加しようとした場合
$ ssh-copy-id -i ~/.ssh/id_ed25519.pub アカウント名@リモートサーバ
...（省略）...
/usr/bin/ssh-copy-id: WARNING: All keys were skipped because they already exist on the remote system.
(if you think this is a mistake, you may want to use -f option)
```

公開鍵がすでに登録されている場合は、エラーを表示して教えてくれます。

## 公開鍵を外部サービスに登録したい

```console
// 公開鍵の内容をコピーする
$ cat ~/.ssh/id_ed25519.pub（公開鍵） | pbcopy
```

外部サービスには、SSH鍵ペアの**公開鍵を登録**してユーザー認証できるものがあります。
その際、手順のどこかで「公開鍵のコピー」が必要です。
ターミナルに表示して、マウスでドラグしてコピーしてもいいのですが、
余計な文字（空白や改行など）をうっかり含めてしまわないか心配です。

そのときは[pbcopy](./command-pbcopy.md)が便利です（macOSのみ）。
（Linuxでは`xclip`コマンドでできるそうです）

:::{note}

GitLabやGitHubなどのサービスでは、具体的な手順を記したページがあります。
それぞれのサービスのヘルプを参照してください。

- [GitHubアカウントへの新しいSSHキーの追加 - GiHub Docs](https://docs.github.com/ja/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account)
- [SSHキーを使ってGitLabと通信します - GitLab日本語マニュアル（クリエーションライン株式会社）](https://gitlab-docs.creationline.com/ee/user/ssh.html)
::
