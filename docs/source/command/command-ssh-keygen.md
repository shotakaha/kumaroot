# SSH鍵したい（`ssh-keygen` / `ssh-add`）

```console
// SSH鍵ペアの確認
$ ssh-keygen -l
Enter file in which the key is (~/.ssh/id_ed25519):

// SSH鍵ペアの生成
$ ssh-keygen

// SSH鍵ペアの登録
$ ssh-add
Enter passphrase for ~/.ssh/id_ed25519
```

`ssh-keygen`コマンドでSSH鍵（公開鍵と秘密鍵のペア）を生成できます。
この鍵は、パスワード入力を省略したSSH接続やGit操作など、SSH認証の自動化に利用できます。

各種サービスに登録するのは必ず**公開鍵**です。
秘密鍵は絶対に誰にも渡してはいけないデータです。
もし、秘密鍵が漏洩してしまった場合は、
外部サービスに登録している公開鍵を削除したり、
端末のSSH鍵を再作成したりする必要があります。

SSH鍵は頻繁に作成するものでもないため、
これまでにSSH鍵を作成したことがあるかどうか、
どの暗号アルゴリズムで鍵を生成したのか、
など忘れてしまっていることも多いと思います。
`-l`オプションで既存のSSH鍵のフィンガープリントなどを表示できるので、
作成したような記憶がある場合は、まず確認してみるとよいです。

:::{note}

SSH鍵はデフォルトで`~/.ssh/`に作成されます。
ディレクトリを直接確認してもよいですが、
`ssh-keygen -l`するほうがお手軽です。

:::

## SSH鍵ペアを作りたい（`ssh-keygen`）

```console
$ ssh-keygen -t ed25519 -C "コメント"
$ ssh-keygen -t ed25519 -C "ユーザー名_パソコンの名前_作成年"
$ ssh-keygen -t ed25519 -f {service}_ed25519 -C "$(whoami)_$(hostname)_$(date +'%Y')"
```

`ssh-keygen`コマンドでSSH鍵（公開鍵と秘密鍵のペア）を作成できます。
秘密鍵を保護するために、専用のパスフレーズを設定してください。

:::{note}

このパスフレーズは、生成した秘密鍵を使用する時に必要となる文字列です。

リモートサーバーにログインするパスワードや、その他のサービスのパスワードとは独立したものなので、同じにする必要はありません。
むしろ、まったく別の文字列を設定することを推奨します。

:::

:::{caution}

秘密鍵のパスフレーズを忘れた場合、復元する方法はありません。
その場合は、新しいSSH鍵を作成し、各サービスに登録している古い公開鍵を削除した上で、新しい公開鍵を登録してください。

:::

`-t`オプションで鍵の種類（アルゴリズム）を変更できます。
選択した鍵の種類に応じて
`~/.ssh/`以下に**秘密鍵**と**公開鍵**のファイルが作成されます。
`-f`オプションで、鍵ファイルの保存先やファイル名を変更できます。

:::{note}

公開鍵と秘密鍵は必ずペアで作成されます。
ファイル名の末尾に`.pub`がついているのが**公開鍵**、
ついていないのが**秘密鍵**です。

ed25519鍵を作成した場合は、デフォルトで
`~/.ssh/id_ed25519.pub`（公開鍵）と
`~/.ssh/id_ed25519`（秘密鍵）が生成されます。

:::

`-C`オプションでコメントを指定できます。
このコメントは人間が識別するためのもので、SSHの鍵認証そのものには影響しません。

自由な文字列を設定できますが、
「誰が（`$(whoami)`）」
「どの端末で（`$(hostname)`）」
「いつごろ（`$(date +"%Y")`）」
作ったかがわかるようにしておくとよいと思います。

:::{note}

コメントは公開鍵ファイルに保存されます。
公開鍵は、第三者に渡る可能性があるデータであるため、秘匿すべき情報はコメントとして入力しないように注意してください。

以前は「メールアドレス」を記載するのが慣習とされていましたが、
個人情報の露出を控えたい場合は、自分自身が識別できる情報に限定して問題ありません。

:::

:::{seealso}

公開鍵そのものは、第三者が取得しても暗号的に問題ありません。
これは公開鍵暗号の設計に基づきます。

ただし、公開鍵末尾のコメントに個人情報や内部情報が含まれている場合、その情報が偵察（OSINT）に利用され、フィッシングの下準備、アカウントの名寄せ、組織情報の推測といった悪用につながる可能性があります。

:::

:::{hint}

職場と自宅で別々の端末を利用するなど、ひとりで複数の端末を所有している場合は多いと思います。
その場合、端末同士は**別人**と考えて、端末ごとにSSH鍵ペアを生成するのがよいです。
各種サービスにも、端末ごとに作成した公開鍵をそれぞれ登録します。

ある端末で作成したSSH鍵ペア（とくに秘密鍵）を、別の端末にコピーして使い回すのでは、
公開鍵暗号を利用する意味がありません。

:::

## 鍵アルゴリズムを変更したい（`ssh-keygen -t`）

```console
// ed25519鍵（デフォルト）
$ ssh-keygen
id_ed25519
id_ed25519.pub

// ECDSA鍵
$ ssh-keygen -t ecdsa
id_ecdsa
id_ecdsa.pub

// RSA鍵
$ ssh-keygen -t rsa
id_rsa
id_rsa.pub
```

`-t`オプションで鍵アルゴリズムを変更できます。
現在のOpenSSH（v9）では、
`ed25519` / `rsa` / `ecdsa`から選択できます。
デフォルトは`ed25519`です。

また、物理セキュリティキー向けの
`ed25519-sk` / `ecdsa-sk`オプションもあります。

:::{seealso}

2020年ころのOpenSSH（v8）では、
鍵アルゴリズムは`rsa` / `dsa` / `ecdsa` / `ed25519` の4種類から選択でき、デフォルトは`rsa`となっていました。

現在では`dsa`は完全に非推奨となっています。
また`rsa`を使う場合は、鍵の長さを3072ビット以上に設定することが推奨されています。

:::

## 鍵の長さを変更したい（`ssh-keygen -b`）

```console
// RSA鍵（3072ビット以上推奨）
$ ssh-keygen -t rsa -b 4096

// ECDSA鍵（256 / 384 / 521ビットから選択）
$ ssh-keygen -t ecdsa -b 521
```

`-b`オプションで`rsa`鍵の長さ（＝ビット数）を変更できます。
`ecdsa`鍵では楕円曲線のサイズを`256 | 384 | 521`から選択できます。

:::{note}

`ed25519`鍵と`*-sk`鍵は鍵長が固定のため、`-b`オプションを指定しても無視されます。

:::

## サービスごとに鍵を作成したい（`ssh-keygen -f`）

```console
// GitHub用
$ ssh-keygen -f ~/.ssh/github_ed25519

// GitLab用
$ ssh-keygen -f ~/.ssh/gitlab_ed25519
```

`-f`オプションで、SSH鍵ぺアのファイル名を変更できます。
このようにしてサービスごとに鍵を切り替えることができます。

:::{seealso}

[SSHの設定ファイル](./command-ssh.md)の`IdentityFile`に秘密鍵のパスを設定することで、サービスごとに自動切り替えできます。

:::

:::{hint}

ある秘密鍵が漏洩してしまった場合、その鍵ペアを無効化する必要があります。
具体的には、関連するすべてのサービスから該当する公開鍵を削除し、必要に応じて新しい鍵ペアを作成・登録しなおす必要があります。

サービスごとに鍵を生成していた場合は、当該サービスに対応する鍵ペアのみを無効化して、再設定すればOKです。
ただし、サービス数が増えると鍵の管理は煩雑になります。
サービスごとに鍵を生成するかどうかは、ユーザー自身の利用形態に合わせて検討してみてください。

:::

## 秘密鍵を登録したい（`ssh-add`）

```console
// 秘密鍵を登録する
$ ssh-add
Enter passphrase for ~/.ssh/id_ed25519: # 秘密鍵のパスワードを入力
Identity added: ~/.ssh/id_ed25519

// 登録を確認する
$ ssh-add -l
256 SHA256:鍵情報 (ED25519)

// macOSの場合: KeyChainに登録する
$ ssh-add --apple-use-keychain ~/.ssh/id_ed25519（秘密鍵）
Identity added: 鍵のパス
```

`ssh-add`は秘密鍵を`ssh-agent`に登録するためのコマンドです。
`ssh-add -l`で登録してある鍵の情報を確認できます。

`ssh-agent`は、秘密鍵の情報を専用メモリに記憶して管理するSSH鍵の番人です。
ログアウトや再起動するとリセットされるため、SSH接続する前に、毎回`ssh-add`する必要があります。

:::{note}

[SSHの設定ファイル](./command-ssh.md)で
`AddKeysToAgent yes`を設定すると、
SSH接続時に自動で`ssh-add`できます。
初回接続時だけ秘密鍵のパスワード入力が必要ですが、以降のセッションでの接続時にはパスワード入力を省略できます。

:::

macOSの場合は
`--apple-use-keychain`することで、
KeyChainアプリに秘密鍵のパスワードを保存できます。
SSH接続時には、KeyChainアプリから秘密鍵のパスワードを取得して`ssh-agent`と連携してくれるため、ユーザーによるパスワード入力を省略できます。

:::{note}

GitHubなどを公開鍵認証にしていると、プッシュするたびにSSH鍵のマスターパスワードの入力が必要です。
SSHエージェントに登録しておくと、その入力が省略できます。

:::

## 公開鍵をリモートサーバ登録したい（``ssh-copy-id``）

```console
// 公開鍵をリモートサーバに登録する
$ ssh-copy-id -i ~/.ssh/id_ed25519.pub アカウント名@リモートサーバ
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "~/.ssh/id_ed25519.pub"
...（省略）...
アカウント名@リモートサーバ's password:    ## リモートサーバのログインパスワードを入力

Number of key(s) added:        1
...（省略）...
```

``ssh-copy-id``コマンドを使って、SSH公開鍵をリモートサーバに登録できます。
ひとつのリモートサーバに対して複数の公開鍵を登録できます。
職場と自宅で別々の端末を使っている場合は、端末ごとの公開鍵を登録できます。

```console
// すでに登録されている公開鍵を、追加しようとした場合
$ ssh-copy-id -i ~/.ssh/id_ed25519.pub アカウント名@リモートサーバ
...（省略）...
/usr/bin/ssh-copy-id: WARNING: All keys were skipped because they already exist on the remote system.
(if you think this is a mistake, you may want to use -f option)
```

公開鍵がすでに登録されている場合は、エラーを表示して教えてくれます。

## 公開鍵を外部サービスに登録したい

```console
// 公開鍵の内容をコピーする
$ cat ~/.ssh/id_ed25519.pub（公開鍵） | pbcopy
```

外部サービスには、SSH鍵ペアの**公開鍵を登録**してユーザー認証できるものがあります。
その際、手順のどこかで「公開鍵のコピー」が必要です。
ターミナルに表示して、マウスでドラグしてコピーしてもいいのですが、
余計な文字（空白や改行など）をうっかり含めてしまわないか心配です。

そのときは[pbcopy](./command-pbcopy.md)が便利です（macOSのみ）。
（Linuxでは`xclip`コマンドでできるそうです）

:::{note}

GitLabやGitHubなどのサービスでは、具体的な手順を記したページがあります。
それぞれのサービスのヘルプを参照してください。

- [GitHubアカウントへの新しいSSHキーの追加 - GiHub Docs](https://docs.github.com/ja/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account)
- [SSHキーを使ってGitLabと通信します - GitLab日本語マニュアル（クリエーションライン株式会社）](https://gitlab-docs.creationline.com/ee/user/ssh.html)
::
